{
  "feature": "Output Validation Before Tool Execution",
  "description": "Add output validation layer that inspects agent-generated commands and file changes before execution. This catches potentially harmful operations that slip through the allowlist.",
  "created_at": "2026-01-11T19:18:36.442Z",
  "updated_at": "2026-01-11T21:46:12.004Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "phases": [
    {
      "id": "phase-1",
      "name": "Core Validation Framework",
      "description": "Create the foundational output validation system that inspects all agent tool calls before execution",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Create output validation models and types",
          "description": "Define data models for validation rules, validation results, and configuration schema. Create types for rule priorities, severity levels, and override tokens.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/models.py"
          ],
          "acceptance_criteria": [
            "ValidationRule model with pattern, severity, tool_types, and message fields",
            "ValidationResult model with is_blocked, rule_id, reason, and suggestions fields",
            "OutputValidationConfig model for per-project configuration",
            "OverrideToken model for user bypass mechanism"
          ]
        },
        {
          "id": "1.2",
          "title": "Implement dangerous pattern detection engine",
          "description": "Create the core pattern matching engine that detects dangerous operations in tool outputs. Support regex patterns, literal matches, and semantic detection.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/pattern_detector.py"
          ],
          "acceptance_criteria": [
            "PatternDetector class with match() method",
            "Support for regex patterns with named groups",
            "Context-aware matching (command vs file content vs file path)",
            "Pattern priority and severity handling"
          ]
        },
        {
          "id": "1.3",
          "title": "Create default validation rule sets",
          "description": "Define comprehensive default rules for dangerous operations across all tool types (Bash, Write, Edit). Include patterns for rm -rf, drop database, secret exposure, etc.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/rules.py"
          ],
          "acceptance_criteria": [
            "BASH_RULES: dangerous command patterns (rm -rf /, drop database, etc.)",
            "FILE_WRITE_RULES: dangerous file content patterns (secrets, malware indicators)",
            "FILE_PATH_RULES: dangerous path patterns (system files, config overwrites)",
            "Rules organized by category with clear documentation"
          ]
        },
        {
          "id": "1.4",
          "title": "Implement output validation hook",
          "description": "Create the main pre-tool-use hook that routes tool calls to appropriate validators. Integrate with existing bash_security_hook and extend to Write, Edit, and other tools.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/hook.py"
          ],
          "acceptance_criteria": [
            "output_validation_hook async function matching SDK hook signature",
            "Routes to tool-specific validators (Bash, Write, Edit, WebFetch)",
            "Returns block decision with clear reason when dangerous pattern detected",
            "Integrates with existing bash_security_hook (extends, doesn't replace)"
          ]
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Tool-Specific Validators",
      "description": "Implement validators for each tool type that needs output validation",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Create Write tool validator",
          "description": "Validate Write tool calls to catch dangerous file writes. Check file paths for system directories and content for secrets/malware patterns.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/validators/write_validator.py"
          ],
          "acceptance_criteria": [
            "Block writes to system directories (/etc, /usr, /bin, etc.)",
            "Block writes to authentication files (.ssh/authorized_keys, /etc/passwd)",
            "Detect and warn on potential secret exposure in file content",
            "Block writes that would overwrite critical config files"
          ]
        },
        {
          "id": "2.2",
          "title": "Create Edit tool validator",
          "description": "Validate Edit tool calls to catch dangerous modifications. Check for malicious code injection patterns and dangerous config changes.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/validators/edit_validator.py"
          ],
          "acceptance_criteria": [
            "Block edits to system files",
            "Detect code injection patterns (eval, exec, __import__)",
            "Block changes that would disable security features",
            "Warn on changes to security-sensitive files (.env, config.json)"
          ]
        },
        {
          "id": "2.3",
          "title": "Extend Bash validator with pattern detection",
          "description": "Enhance existing Bash validation to use the new pattern detection engine. Add patterns for more dangerous command sequences.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/validators/bash_validator.py",
            "apps/backend/security/output_validation/validators/test_bash_validator_simple.py"
          ],
          "acceptance_criteria": [
            "Integrates with existing bash_security_hook logic",
            "Adds pattern detection for complex command chains",
            "Detects obfuscated dangerous commands (base64 encoded, variable expansion)",
            "Catches privilege escalation attempts (sudo, chmod 777, etc.)"
          ]
        },
        {
          "id": "2.4",
          "title": "Create validator registry",
          "description": "Central registry that maps tool names to their validators. Provides lookup and iteration over all validators.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/validators/__init__.py",
            "apps/backend/security/output_validation/validators/test_validator_registry.py"
          ],
          "acceptance_criteria": [
            "TOOL_VALIDATORS dict mapping tool names to validator functions",
            "get_validator(tool_name) lookup function",
            "validate_tool_output(tool_name, tool_input) unified interface",
            "Support for registering custom validators"
          ],
          "notes": "Implemented comprehensive validator registry with TOOL_VALIDATORS dict, get_validator(), validate_tool_output(), register_validator(), unregister_validator(), list_validators(), and has_validator() functions. Created test suite with 25+ tests. All acceptance criteria met."
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Configuration System",
      "description": "Implement per-project configurable validation rules",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Create validation config loader",
          "description": "Load validation configuration from project's .auto-claude directory. Support JSON/YAML config format with schema validation.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/config.py",
            "apps/backend/security/output_validation/test_config.py",
            "apps/backend/security/output_validation/test_config_manual.py"
          ],
          "acceptance_criteria": [
            "Load config from .auto-claude/output-validation.json",
            "Support YAML format as alternative",
            "Schema validation with helpful error messages",
            "Merge project config with defaults (project config takes precedence)"
          ],
          "notes": "Implemented ValidationConfigLoader class with full JSON/YAML support, schema validation with helpful error messages, custom rules validation, config caching, and comprehensive test coverage. All acceptance criteria met."
        },
        {
          "id": "3.2",
          "title": "Implement custom rule support",
          "description": "Allow projects to define custom validation rules in their config. Support rule enable/disable, custom patterns, and severity overrides.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/custom_rules.py",
            "apps/backend/security/output_validation/test_custom_rules.py",
            "apps/backend/security/output_validation/__init__.py"
          ],
          "acceptance_criteria": [
            "Parse custom rules from project config",
            "Validate custom rule syntax and pattern safety",
            "Support disabling default rules by ID",
            "Support severity overrides for default rules"
          ],
          "notes": "Implemented comprehensive custom rules support with pattern safety validation (ReDoS detection), rule loading/merging, configuration overrides, and 35 passing tests. All acceptance criteria met."
        },
        {
          "id": "3.3",
          "title": "Add allowed paths configuration",
          "description": "Allow projects to define paths that bypass certain validation rules. Useful for test directories, build outputs, etc.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/allowed_paths.py",
            "apps/backend/security/output_validation/test_allowed_paths.py",
            "apps/backend/security/output_validation/test_allowed_paths_smoke.py",
            "apps/backend/security/output_validation/__init__.py"
          ],
          "acceptance_criteria": [
            "Configure allowed paths for file operations",
            "Support glob patterns (tests/**, build/**, .git/**)",
            "Path allowlist checked before pattern detection",
            "Logging when path allowlist is used"
          ],
          "notes": "Implemented AllowedPathsChecker class with comprehensive glob pattern support, convenience functions (is_path_allowed, get_allowed_paths, compile_glob_patterns), pattern utilities (normalize_pattern, pattern_to_regex), logging on bypass, and 40+ passing tests. All acceptance criteria met."
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Override Mechanism",
      "description": "Allow users to override specific validations when needed",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Implement override token system",
          "description": "Create a mechanism for users to generate override tokens that bypass specific validation rules for a limited time or scope.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/overrides.py",
            "apps/backend/security/output_validation/test_overrides.py",
            "apps/backend/security/output_validation/test_overrides_smoke.py",
            "apps/backend/security/output_validation/__init__.py"
          ],
          "acceptance_criteria": [
            "generate_override_token(rule_id, scope, expiry) function",
            "Tokens stored in .auto-claude/override-tokens.json",
            "Time-limited tokens (default 1 hour expiry)",
            "Scope-limited tokens (specific file, specific command)"
          ],
          "notes": "Implemented comprehensive override token system with OverrideTokenManager class for token lifecycle management, TokenStorage class for file-based persistence, scope formatting utilities (file:, command:, all), and convenience functions. All 12 test suites pass successfully. Features include: token generation with customizable scope/time/usage limits, validation with rule ID and scope matching, usage tracking, revocation, listing, cleanup of expired tokens, and JSON persistence in .auto-claude/override-tokens.json. All acceptance criteria met."
        },
        {
          "id": "4.2",
          "title": "Add CLI commands for override management",
          "description": "Add CLI commands to manage validation overrides. Allow users to create, list, and revoke override tokens.",
          "status": "completed",
          "files": [
            "apps/backend/cli/override_commands.py"
          ],
          "acceptance_criteria": [
            "auto-claude override create --rule <rule-id> command",
            "auto-claude override list command to show active overrides",
            "auto-claude override revoke <token-id> command",
            "Clear output showing override scope and expiry"
          ]
        },
        {
          "id": "4.3",
          "title": "Integrate override checking in validation hook",
          "description": "Check for valid override tokens before blocking operations. Log override usage for audit trail.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/hook.py",
            "apps/backend/security/output_validation/overrides.py",
            "apps/backend/security/output_validation/test_hook_override_integration.py"
          ],
          "acceptance_criteria": [
            "Check override tokens before returning block decision",
            "Validate token expiry and scope",
            "Log all override usage with timestamp and context",
            "Decrement usage count for limited-use tokens"
          ],
          "notes": "Implemented comprehensive override token checking in output_validation_hook. Added _get_override_context() to format context strings (file:, command:). Added _check_override_tokens() to validate and use override tokens with proper logging. Fixed TokenStorage.load_tokens() to support include_invalid parameter for listing exhausted tokens. Fixed OverrideTokenManager.list_tokens() to force reload when include_expired=True. Created 14 comprehensive integration tests covering all acceptance criteria. All tests pass successfully."
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Logging and Reporting",
      "description": "Comprehensive logging of validation events with clear explanations",
      "subtasks": [
        {
          "id": "5.1",
          "title": "Create validation event logger",
          "description": "Structured logging for all validation events. Include blocked operations, warnings, and override usage.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/logger.py",
            "apps/backend/security/output_validation/test_logger.py",
            "apps/backend/security/output_validation/test_logger_smoke.py"
          ],
          "acceptance_criteria": [
            "ValidationEvent dataclass with all relevant fields",
            "Log blocked operations with full context",
            "Log warnings for suspicious but allowed operations",
            "Structured JSON format for log entries"
          ],
          "notes": "Implemented ValidationEventLogger class with comprehensive logging capabilities. Features include: blocked/warning/allowed event logging, override usage tracking, event filtering by decision/tool/rule, statistics generation, tool input sanitization (sensitive data redaction), in-memory storage with optional file persistence, global logger instance management, and convenience functions. All smoke tests pass successfully."
        },
        {
          "id": "5.2",
          "title": "Implement validation report generation",
          "description": "Generate summary reports of validation events per build session. Show what was blocked and why.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/report.py",
            "apps/backend/security/output_validation/test_report.py",
            "apps/backend/security/output_validation/test_report_smoke.py",
            "apps/backend/security/output_validation/__init__.py"
          ],
          "acceptance_criteria": [
            "Generate per-session validation summary",
            "Include statistics (total checked, blocked, warnings)",
            "List all blocked operations with explanations",
            "Save report to spec directory (validation-report.md)"
          ],
          "notes": "Implemented comprehensive ValidationReportGenerator class with markdown report generation. Features include: summary statistics table, blocked operations grouped by rule with severity icons and explanations, warning events section, override token usage tracking, statistics by tool type, severity breakdown, save to spec directory as validation-report.md, console summary printing, and convenience functions. Created 40+ pytest tests and 9 smoke tests (all passing). Added exports to __init__.py. All acceptance criteria met."
        },
        {
          "id": "5.3",
          "title": "Add user-friendly block messages",
          "description": "Improve block messages to be actionable. Include what was blocked, why, and how to override if needed.",
          "status": "completed",
          "files": [
            "apps/backend/security/output_validation/messages.py",
            "apps/backend/security/output_validation/test_messages.py",
            "apps/backend/security/output_validation/__init__.py"
          ],
          "acceptance_criteria": [
            "Clear, non-technical explanation of what was blocked",
            "Specific reason referencing the validation rule",
            "Suggestion for how to proceed (modify command, use override)",
            "Link to documentation for the specific rule"
          ],
          "notes": "Implemented comprehensive message formatting module with format_block_message() that generates user-friendly, actionable block messages. Messages include: severity-appropriate header (üö® Critical, ‚ö†Ô∏è High-Risk, etc.), what was blocked (operation type and details), why it was blocked (rule explanation), actionable suggestions from rule definition, override instructions with CLI commands, and documentation links. Added helper functions for short messages, override instructions, tool descriptions, validation summaries, and doc URLs. Created 25+ pytest tests covering all formatting functions, tool types, severity levels, and edge cases. All acceptance criteria met - messages are clear, non-technical, actionable, and include override guidance."
        }
      ]
    },
    {
      "id": "phase-6",
      "name": "Integration",
      "description": "Integrate output validation into the existing agent pipeline",
      "subtasks": [
        {
          "id": "6.1",
          "title": "Update client.py to use output validation hook",
          "description": "Modify create_client() to register the output validation hook alongside bash_security_hook. Ensure proper ordering of hooks.",
          "status": "completed",
          "files": [
            "apps/backend/core/client.py"
          ],
          "acceptance_criteria": [
            "output_validation_hook registered as PreToolUse hook",
            "Hook runs before bash_security_hook for Bash commands",
            "Hook configuration passed from project settings",
            "Hook receives project_dir for per-project config"
          ]
        },
        {
          "id": "6.2",
          "title": "Update security module exports",
          "description": "Export new validation functions from the security module. Maintain backwards compatibility with existing imports.",
          "status": "completed",
          "files": [
            "apps/backend/security/__init__.py"
          ],
          "acceptance_criteria": [
            "Export output_validation_hook",
            "Export validation config functions",
            "Export override management functions",
            "Backwards compatible with existing imports"
          ],
          "notes": "Successfully exported all output validation functions from security module. Added 28 new exports including output_validation_hook, validation config functions (get_validation_config, load_validation_config, clear_config_cache), override management functions (generate_override_token, validate_override_token, use_override_token, revoke_override_token, list_override_tokens), models and enums (SeverityLevel, ValidationResult, ValidationRule, OutputValidationConfig, OverrideToken), logging functions (log_blocked_operation, log_warning, log_override_used), reporting functions (generate_validation_report, generate_and_save_report, print_validation_summary), and message formatting functions (format_block_message, format_short_block_message). All existing exports maintained for full backwards compatibility. Updated module docstring to reflect new capabilities. Comprehensive tests confirm all imports work correctly and backwards compatibility is maintained."
        },
        {
          "id": "6.3",
          "title": "Add integration tests",
          "description": "Comprehensive tests for the output validation system. Cover all tool types, rule matching, overrides, and configuration.",
          "status": "completed",
          "files": [
            "tests/test_output_validation.py",
            "tests/test_output_validation_smoke.py"
          ],
          "acceptance_criteria": [
            "Test dangerous pattern detection for each tool type",
            "Test per-project configuration loading",
            "Test override token creation and validation",
            "Test integration with SDK hook system"
          ],
          "notes": "Created comprehensive test suite with 40+ pytest tests covering pattern detection (Bash, Write, Edit, WebFetch, WebSearch), configuration loading, override token lifecycle, SDK hook integration, validator registry, logging/reporting, and end-to-end workflows. Also created manual smoke test script (test_output_validation_smoke.py) that runs without pytest. All 8 test suites passing successfully. All acceptance criteria met."
        },
        {
          "id": "6.4",
          "title": "Update documentation",
          "description": "Document the output validation system in CLAUDE.md and create dedicated guide for configuration.",
          "status": "completed",
          "files": [
            "CLAUDE.md",
            "guides/output-validation.md",
            "guides/README.md"
          ],
          "acceptance_criteria": [
            "Add output validation section to CLAUDE.md",
            "Create comprehensive guide with examples",
            "Document all default rules and their IDs",
            "Document override mechanism with examples"
          ],
          "notes": "Added comprehensive output validation section to CLAUDE.md explaining the four-layer security model and the new output validation system. Created detailed 400+ line guide (guides/output-validation.md) covering: overview, architecture, configuration (JSON/YAML), complete rule reference with all 40+ default rules, override mechanism with CLI commands, validation reports, best practices, troubleshooting, advanced topics, and security considerations. Updated guides/README.md to include the new guide. All acceptance criteria met."
        }
      ]
    }
  ],
  "qa_status": {
    "status": "pending",
    "issues": [],
    "tests_passed": ""
  },
  "metadata": {
    "estimated_complexity": "medium",
    "total_subtasks": 20,
    "key_files": [
      "apps/backend/security/output_validation/",
      "apps/backend/core/client.py",
      "apps/backend/cli/override_commands.py",
      "tests/test_output_validation.py"
    ],
    "dependencies": [
      "Existing security module (apps/backend/security/)",
      "Claude Agent SDK hooks system",
      "Project analyzer for context"
    ]
  }
}